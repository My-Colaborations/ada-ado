# Database Statements
The `ADO.Statements` package provides high level operations to construct database
statements and execute them.  They allow to represent SQL statements (prepared or not)
and provide support to execute them and retreive their result.  The SQL statements are
represented by several Ada types depending on their behavior:

* The `Statement` type represents the base type for all the SQL statements.
* The `Query_Statement` type is intended to be used for database query statements and provides additional operations to retrieve results.
* The `Update_Statement` type targets the database update statements and it provides specific operations to update fields.  The `Insert_Statement` extends the `Update_Statement` type and is intended for database insertion.
* The `Delete_Statement` type is intended to be used to remove elements from the database.

The database statements are created by using the database session and by providing
the SQL or the named query to be used.

## Query Parameters
Query parameters are represented by the <tt>Parameter</tt> type which can represent almost
all database types including boolean, numbers, strings, dates and blob.  Parameters are
put in a list represented by the <tt>Abstract_List</tt> or <tt>List</tt> types.

A parameter is added by using either the <tt>Bind_Param</tt> or the <tt>Add_Param</tt>
operation.  The <tt>Bind_Param</tt> operation allows to specify either the parameter name
or its position.  The <tt>Add_Param</tt> operation adds the parameter at end of the list
and uses the last position.  In most cases, it is easier to bind a parameter with a name
as follows:

```Ada
Query.Bind_Param ("name", "Joe");
```

and the SQL can use the following construct:

```Ada
SELECT * FROM user WHERE name = :name
```

When the <tt>Add_Param</tt> is used, the parameter is not associated with any name but it
as a position index.  Setting a parameter is easier:

```Ada
Query.Add_Param ("Joe");
```

but the SQL cannot make any reference to names and must use the <tt>?</tt> construct:

```Ada
SELECT * FROM user WHERE name = ?
```

### Parameter Expander
The parameter expander is a mechanism that allows to replace or inject values in the SQL
query by looking at an operation provided by the <tt>Expander</tt> interface.  Such expander
is useful to replace parameters that are global to a session or to an application.



## Query Statement
The database query statement is represented by the `Query_Statement` type.
The `Create_Statement` operation is provided on the `Session` type
and it gets the SQL to execute as parameter.  For example:

```Ada
Stmt : ADO.Statements.Query_Statement := Session.Create_Statement
          ("select * from user where name = :name");
```

After the creation of the query statement, the parameters for the SQL query are provided
by using either the `Bind_Param` or `Add_Param` procedures as follows:

```Ada
Stmt.Bind_Param ("name", name);
```

Once all the parameters are defined, the query statement is executed by calling the
`Execute` procedure:

```Ada
Stmt.Execute;
```

Several operations are provided to retrieve the result.  First, the `Has_Elements`
function will indicate whether some database rows are available in the result.  It is then
possible to retrieve each row and proceed to the next one by calling the `Next`
procedure.  The number of rows is also returned by the `Get_Row_Count` function.
A simple loop to iterate over the query result looks like:

```Ada
while Stmt.Has_Elements loop
   Id := Stmt.Get_Identifier (1);
   ...
   Stmt.Next;
end loop;
```

## Named Queries
Ada Database Objects provides a small framework which helps in
using complex SQL queries in an application by using named queries.
The benefit of the framework are the following:

  * The SQL query result are directly mapped in Ada records,
  * It is easy to change or tune an SQL query without re-building the application,
  * The SQL query can be easily tuned for a given database.

The database query framework uses an XML query file:

  * The XML query file defines a mapping that represents the result of SQL queries,
  * The XML mapping is used by Dynamo to generate an Ada record,
  * The XML query file also defines a set of SQL queries, each query being identified by a unique name,
  * The XML query file is read by the application to obtain the SQL query associated with a query name,
  * The application uses the `List` procedure generated by Dynamo.

### XML Query File
The XML query file uses the `query-mapping` root element.  It should
define at most one `class` mapping and several `query` definitions.
The `class` definition should come first before any `query` definition.

```Ada
<query-mapping>
   <class>...</class>
   <query>...</query>
</query-mapping>
```

### SQL Result Mapping
The XML query mapping is very close to the database table mapping.
The difference is that there is no need to specify any table name
nor any SQL type.  The XML query mapping is used to build an Ada
record that correspond to query results.  Unlike the database table mapping,
the Ada record will not be tagged and its definition will expose all the record
members directly.

The following XML query mapping:

```Ada
<query-mapping>
  <class name='Samples.Model.User_Info'>
    <property name="name" type="String">
       <comment>the user name</comment>
    </property>
    <property name="email" type="String">
       <comment>the email address</comment>
    </property>
  </class>
</query-mapping>
```

will generate the following Ada record:

```Ada
package Samples.Model is
   type User_Info is record
     Name  : Unbounded_String;
     Email : Unbounded_String;
   end record;
end Samples.Model;
```

The same query mapping can be used by different queries.

### SQL Queries
The XML query file defines a list of SQL queries that the application
can use.  Each query is associated with a unique name.  The application
will use that name to identify the SQL query to execute.  For each query,
the file also describes the SQL query pattern that must be used for
the query execution.

```Ada
<query name='xxx' class='Samples.Model.User_Info'>
   <sql driver='mysql'>
     select u.name, u.email from user
   </sql>
   <sql driver='sqlite'>
      ...
   </sql>
   <sql-count driver='mysql'>
      select count(*) from user u
   </sql-count>
</query>
```

The query contains basically two SQL patterns.  The `sql` element represents
the main SQL pattern.  This is the SQL that is used by the `List` operation.
In some cases, the result set returned by the query is limited to return only
a maximum number of rows.  This is often use in paginated lists.

The `sql-count` element represents an SQL query to indicate the total number
of elements if the SQL query was not limited.


